name: Unstoppable Bot 24/7

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '*/30 * * * *'  # محاولة تفقد كل 30 دقيقة (سيعرف GitHub أن البوت يعمل ولن يشغل نسخة ثانية)
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install
        run: pip install python-telegram-bot pymongo dnspython

      - name: Persistent Run
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          # الحيلة: البوت سيعمل لمدة 5 ساعات و 50 دقيقة ثم يغلق نفسه بكود نجاح
          # هذا يمنع تعليق الجلسة ويضمن تشغيل الـ cron التالي
          timeout 21000s python run_bot.py || echo "Restarting for stability..."
